---
- hosts: all
  tasks:
    - name: Install addition packages
      apt: name={{item}} state=latest
      with_items:
        - traceroute
        - docker.io
        - python-docker

    - name: Install ETCDTOOL
      command: test -x /usr/local/bin/etcdtool
      register: etcdtool_installed
      ignore_errors: True
    - command: mv /vagrant/files/bin/etcdtool /usr/local/bin/
      when: etcdtool_installed|failed
    - file: path=/usr/local/bin/etcdtool mode=755
      when: etcdtool_installed|failed

    - name: Install and run ETCD
      copy: src=../files/etcd.sh dest=/usr/local/bin/etcd.sh
      register: etcd_sh_installed
    - file: path=/usr/local/bin/etcd.sh mode=755
      when: etcd_sh_installed.changed
    - docker_image: name=quay.io/coreos/etcd:latest
    - template: src="templates/etcd_systemd_unit.j2" dest="/etc/systemd/system/etcd.service"
      register: etcd_unit_installed
    - command: systemctl daemon-reload
      register: when_unit_installed.changed
    - service: name=etcd enabled=yes state=started

    - name: Install CONFD
      command: test -x /usr/local/bin/confd
      register: confd_installed
      ignore_errors: True
    - command: mv /vagrant/files/bin/confd-0.11.0-linux-amd64 /usr/local/bin/confd
      when: confd_installed|failed
    - file: path=/usr/local/bin/confd mode=755
    - file: path=/etc/confd state=directory
    - file: path=/etc/confd/conf.d state=directory
    - file: path=/etc/confd/templates state=directory

    - command: test -x /usr/local/bin/etcdctl
      register: etcdctl_installed
      ignore_errors: True
    - command: docker cp etcd.service:/usr/local/bin/etcdctl /usr/local/bin/etcdctl
      when: etcdctl_installed|failed
    - file: path=/usr/local/bin/etcdctl mode=755
      when: etcdctl_installed|failed

    - copy: src=../network_metadata.yaml dest=/etc/network_metadata.yaml
    - command: etcdctl ls /network_metadata
      register: network_metadata_uploaded
      ignore_errors: True
    - command: etcdtool import -y -f yaml /network_metadata /etc/network_metadata.yaml
      when: network_metadata_uploaded|failed

    - name: Install BIRD bgpd
      apt_repository: repo='ppa:cz.nic-labs/bird'
    - apt: name=bird state=latest update_cache=yes
    - file: path=/etc/init/bird.override state=absent
    - copy: src=templates/bird_master.toml.j2 dest=/etc/confd/conf.d/bird.toml
    - copy: src=templates/bird_master.tmpl.j2 dest=/etc/confd/templates/bird.tmpl
    - name: Generate main BIRD config by confd
      command: confd -onetime
      environment:
        HOSTNAME: "{{ master_node_name }}"
      ignore_errors: True
    - file: path=/var/log/bird state=directory owner=bird group=bird mode=755
    - copy: dest=/var/log/bird/master.log content="Use 'journalctl -u bird' for looking log."
    - name: disable start of bird6 service
      file: path=/etc/bird/bird6.conf state=absent
    - service: name=bird6 enabled=no state=stopped
    - service: name=bird enabled=yes state=reloaded

