---
- hosts: all
  tasks:
    - command: test -x /usr/local/bin/confd
      register: confd_installed
      ignore_errors: True
    - command: mv /vagrant/files/bin/confd-0.11.0-linux-amd64 /usr/local/bin/confd
      when: confd_installed|failed
    - file: path=/usr/local/bin/confd mode=755
    - file: path=/etc/confd state=directory
    - file: path=/etc/confd/conf.d state=directory
    - file: path=/etc/confd/templates state=directory

    - command: test -x /usr/local/bin/etcdtool
      register: etcdtool_installed
      ignore_errors: True
    - command: mv /vagrant/files/bin/etcdtool /usr/local/bin/
      when: etcdtool_installed|failed
    - file: path=/usr/local/bin/etcdtool mode=755

    - command: test -x /usr/local/bin/etcdctl
      register: etcdctl_installed
      ignore_errors: True
    - command: docker cp quay.io-coreos-etcd:/usr/local/bin/etcdctl /usr/local/bin/etcdctl
      when: etcdctl_installed|failed
    - file: path=/usr/local/bin/etcdctl mode=755

    - copy: src=../network_metadata.yaml dest=/etc/network_metadata.yaml
    - command: etcdctl ls /network_metadata
      register: network_metadata_uploaded
      ignore_errors: True
    - command: etcdtool import -r -y -f yaml /network_metadata /etc/network_metadata.yaml
      when: network_metadata_uploaded|failed

    - command: test -x /usr/local/bin/virt-router.sh
      register: virt_router_installed
      ignore_errors: True
    - command: mv /vagrant/files/virt-router.sh /usr/local/bin/
      when: virt_router_installed|failed

    - file: path=/etc/init/bird.override state=touch
    - file: path=/etc/init/bird6.override state=touch
    - apt_repository: repo='ppa:cz.nic-labs/bird'
    - apt: name=bird state=latest update_cache=yes
    - file: path=/etc/init/bird.override state=absent
    - copy: src=templates/bird_master.toml.j2 dest=/etc/confd/conf.d/bird.toml
    - copy: src=templates/bird_master.tmpl.j2 dest=/etc/confd/templates/bird.tmpl
    - command: confd -onetime
      environment:
        HOSTNAME: svasilenko-mr-000
      ignore_errors: True
    - service: name=bird enabled=yes state=started
